<!DOCTYPE html>
<html>
<head>
  <title>Laser Squares</title>
  <style>
    html { overflow: hidden; }
    body {
      margin: 0; padding: 20px;
      background: #222; color: white;
      font-family: Arial, sans-serif;
      display: flex; flex-direction: column;
      min-height: 100vh; overflow: hidden;
    }
    .title { text-align: center; font-size: 2em; margin-bottom: 20px; }
    .container { flex: 1; display: flex; row-gap: 20px; justify-content: center; gap: 20px; }
    .game-area { display: flex; flex-direction: column; align-items: center; }
    canvas { background: #111; border: 1px solid #555; }
    .leaderboard {
      background: #333; padding: 10px;
      border: 1px solid #555;
      min-width: 150px; max-width: 200px;
      height: 400px; overflow-y: auto;
    }
    .leaderboard h3 { margin-top: 0; }
    #info { margin-top: 10px; }
    #loginOverlay {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      display: flex; align-items: center;
      justify-content: center; z-index: 10;
    }
    #loginBox {
      background: #444; padding: 20px;
      border: 1px solid #666; border-radius: 5px;
      text-align: center;
    }
    #loginBox h2 { margin-top: 0; }
    #loginBox input { padding: 8px; width: 200px; border: none; border-radius: 3px; margin-bottom: 10px; }
    #loginBox button, #logoutButton {
      padding: 8px 16px; border: none;
      border-radius: 3px; font-weight: bold;
      cursor: pointer;
    }
    #loginBox button { background: lime; color: #222; }
    #logoutButton { background: #e74c3c; color: white; display: none; margin-top: 10px; }
    footer {
      position: fixed; bottom: 0; left: 0;
      width: 100%; text-align: center;
      padding: 30px 0; background: #222;
      border-top: 1px solid #555;
    }
  </style>
</head>
<body>
  <div class="title">Laser Squares</div>
  <div class="container">
    <div class="game-area">
      <canvas id="game" width="400" height="400"></canvas>
      <div id="info"></div>
      <button id="logoutButton">Logout</button>
    </div>
    <div class="leaderboard">
      <h3>Leaderboard</h3>
      <ul id="leaderboardList" style="list-style:none; padding:0;"></ul>
    </div>
  </div>

  <div id="loginOverlay">
    <div id="loginBox">
      <h2>Welcome to Laser Squares</h2>
      <p>Enter your player name:</p>
      <input type="text" id="playerNameInput" placeholder="Player name">
      <br>
      <button id="loginButton">Join Game</button>
    </div>
  </div>

  <footer>Made by Giancarlo Umberto Ambrosino</footer>

  <script>
    // WebSocket endpoint 
    const wsUrl = "wss://besdqwvktd.execute-api.us-east-2.amazonaws.com/production/";
    let socket;
    let player = "";

    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const logoutButton = document.getElementById("logoutButton");

    const gridSize = 10;
    const cellSize = canvas.width / gridSize;

    let playerList = [];
    let localPlayerPos = { x: 0, y: 0 };
    let projectiles = [];

    function connectSocket() {
      socket = new WebSocket(`${wsUrl}?name=${encodeURIComponent(player)}`);

      socket.onopen = () => {
        // request gameState every 2 seconds
        setInterval(() => {
          socket.send(JSON.stringify({ action: "getGameState" }));
        }, 2000);
        requestAnimationFrame(animationLoop);
      };

      socket.onmessage = ({ data }) => {
        const msg = JSON.parse(data);
        switch (msg.action) {
          case "gameState":
            playerList = msg.players;
            const me = playerList.find(p => p.name === player);
            if (me) {
              localPlayerPos.x = me.x;
              localPlayerPos.y = me.y;
            }
            updateLeaderboard();
            break;

          case "playerMoved":
            localPlayerPos.x = msg.x;
            localPlayerPos.y = msg.y;
            break;

          case "shootResult":
            document.getElementById("info").innerText = `${msg.result} | ${msg.score}`;
            break;
        }
      };

      socket.onclose = () => {
        alert("Disconnected from server");
        location.reload();
      };

      socket.onerror = err => console.error("WebSocket error:", err);
    }

    function movePlayer(direction) {
      socket.send(JSON.stringify({ action: "playerMove", name: player, direction }));
    }

    function shoot(direction) {
      addProjectile(direction);
      socket.send(JSON.stringify({ action: "shoot", name: player, direction }));
    }

    function logout() {
      socket.close();
    }

    function updateLeaderboard() {
      const lbEl = document.getElementById("leaderboardList");
      lbEl.innerHTML = "";
      const sorted = playerList.slice().sort((a, b) => b.score - a.score);
      sorted.forEach(p => {
        const li = document.createElement("li");
        li.textContent = `${p.name}: ${p.score}`;
        lbEl.appendChild(li);
      });
    }

    function render() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const onlinePlayers = playerList.filter(p => p.online);
      onlinePlayers.forEach(p => {
        ctx.fillStyle = p.name === player ? "lime" : "red";
        ctx.fillRect(p.x * cellSize, p.y * cellSize, cellSize - 2, cellSize - 2);
      });

      projectiles.forEach(proj => {
        ctx.fillStyle = "yellow";
        ctx.beginPath();
        ctx.arc(
          proj.x * cellSize + cellSize / 2,
          proj.y * cellSize + cellSize / 2,
          cellSize / 8,
          0, Math.PI * 2
        );
        ctx.fill();
      });
    }

    function updateProjectiles(deltaTime) {
      const speed = 5;
      const distance = speed * (deltaTime / 1000);
      projectiles.forEach(proj => {
        switch (proj.direction) {
          case "up": proj.y -= distance; break;
          case "down": proj.y += distance; break;
          case "left": proj.x -= distance; break;
          case "right": proj.x += distance; break;
        }
        proj.life -= deltaTime;
      });
      projectiles = projectiles.filter(proj =>
        proj.life > 0 && proj.x >= 0 && proj.x < gridSize && proj.y >= 0 && proj.y < gridSize
      );
    }

    function animationLoop(timestamp) {
      if (!animationLoop.lastTimestamp) animationLoop.lastTimestamp = timestamp;
      const deltaTime = timestamp - animationLoop.lastTimestamp;
      animationLoop.lastTimestamp = timestamp;

      updateProjectiles(deltaTime);
      render();
      requestAnimationFrame(animationLoop);
    }

    function addProjectile(direction) {
      projectiles.push({ x: localPlayerPos.x, y: localPlayerPos.y, direction, life: 1000 });
    }

    document.addEventListener("keydown", e => {
      const moveKeys = { ArrowUp: "up", ArrowDown: "down", ArrowLeft: "left", ArrowRight: "right" };
      const shootKeys = { KeyW: "up", KeyS: "down", KeyA: "left", KeyD: "right" };

      if (moveKeys[e.code]) {
        movePlayer(moveKeys[e.code]);
      } else if (shootKeys[e.code]) {
        shoot(shootKeys[e.code]);
      }
    });

    const loginOverlay = document.getElementById("loginOverlay");
    const loginButton = document.getElementById("loginButton");
    loginButton.addEventListener("click", () => {
      const input = document.getElementById("playerNameInput");
      const nameValue = input.value.trim();
      if (!nameValue) return;
      player = nameValue;
      loginOverlay.style.display = "none";
      logoutButton.style.display = "block";
      connectSocket();
    });

    logoutButton.addEventListener("click", logout);
  </script>
</body>
</html>
